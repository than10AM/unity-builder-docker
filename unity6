FROM --platform=linux/amd64 ubuntu:22.04

# Avoid interactive prompts during installation
ENV DEBIAN_FRONTEND=noninteractive

# Install dependencies and required packages
RUN apt-get update && \
    apt-get install -y \
    wget \
    gnupg \
    ca-certificates \
    curl \
    sudo \
    apt-transport-https \
    lsb-release \
    gpg \
    xvfb \
    libglu1-mesa \
    libgtk-3-0 \
    libfuse2 \
    unzip \
    software-properties-common \
    libasound2 \
    alsa-utils \
    pulseaudio \
    libdbus-1-3 \
    libgbm1 \
    dbus

# Setup dbus
RUN mkdir -p /var/run/dbus && \
    dbus-daemon --system

# Print system information for debugging
RUN echo "Architecture: $(dpkg --print-architecture)" && \
    echo "OS Release: $(lsb_release -a)"

# Add Unity official repository and install Unity Hub
RUN wget -qO - https://hub.unity3d.com/linux/keys/public | gpg --dearmor | sudo tee /usr/share/keyrings/unity-hub-archive-keyring.gpg > /dev/null
RUN echo "deb [signed-by=/usr/share/keyrings/unity-hub-archive-keyring.gpg] https://hub.unity3d.com/linux/repos/deb stable main" | sudo tee /etc/apt/sources.list.d/unity-hub.list
RUN apt-get update && apt-get install -y unityhub

# Create Unity Hub directory structure
RUN mkdir -p /opt/unity && \
    mkdir -p /root/.config/Unity\ Hub

# Add a script to install Unity (will run at container start)
RUN echo '#!/bin/bash \n\
Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 & \n\
export DISPLAY=:99 \n\
service dbus start || true \n\
echo "Setting Unity install path..." \n\
unityhub --headless install-path --set /opt/unity \n\
echo "Available Unity versions:" \n\
unityhub --headless editors --releases \n\
# Use one of the versions from the output above \n\
VERSION="2022.3.62f1" \n\
echo "Installing Unity version $VERSION..." \n\
unityhub --headless install --version $VERSION \n\
echo "Unity installation completed" \n\
tail -f /dev/null' > /install_unity.sh && \
chmod +x /install_unity.sh

# Create a CMD that starts the container and runs the installation script
CMD ["/install_unity.sh"]